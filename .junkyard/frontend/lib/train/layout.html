<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>CuteFront App</title>
    <link href="../lib/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link href="../lib/include/bootstrap-icons/css/bootstrap-icons.min.css" rel="stylesheet">
    <link href="../lib/include/fontawesome/css/all.min.css" rel="stylesheet">
    <style>
        .sidebar {
            position: fixed;
            top: 0;
            bottom: 0;
            left: 0;
            z-index: 100;
            padding: 48px 0 0;
            box-shadow: inset -1px 0 0 rgba(0, 0, 0, .1);
        }
        .main-content {
            margin-left: 250px; /* Adjust based on your sidebar width */
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <div id="sidebar" class="col-12 col-md-auto"></div>
            <div id="main-group" class="col-12 col-md-9 col-lg-10">
            </div>
        </div>
    </div>

    <!-- Network testing widgets (only used when networkTest = true) -->
    <div id="network-sim"></div>
    <div id="loading-indicator"></div>

    <script src="../lib/bootstrap/js/bootstrap.bundle.min.js"></script>
    <script type="module">
        const isTestMode = (
            window.location.protocol === 'file:' ||
            window.location.search.includes('testing=true')
        );
        const networkTest = true; // Enable network testing widgets
        import { ElementWidget } from '../lib/base/widget.js';
        import { ContainerWidget } from '../lib/base/containerwidget.js';
        import { FapiGroup } from './lib/fapigroup.js';
        import { SidebarMenuItem } from '../lib/base/sidebarwidget.js';
        import { FapiSidebar } from './lib/fapisidebar.js';
        import { FapiPaginationStrategy } from './lib/fapipagination.js';
        import { LocalStorageAuthModel } from '../lib/base/authmodel.js';
        // subsections
        import { AuthUserFloaterWidget } from './lib/authuserfloater.js';
        import { DashboardSection } from './layout/sections/dashboard/main.js'
        import { ItemsSection } from './layout/sections/items/main.js'
        import { SettingsSection } from './layout/sections/settings/main.js'
        import { AdminSection } from './layout/sections/admin/main.js'
        // warning banner
        import { BannerWidget } from './lib/banner.js';
        import { LoadingIndicatorWidget } from '../lib/base/loadingindicatorwidget.js';
        // datasources
        // authenticated user
        import { AuthUserHTTPDataSource, AuthUserMockDataSource } from './datapi/authuser/datasource.js'
        import { AuthUserDataSourceWidget } from './datapi/authuser/datawidget.js'
        // items
        import { ItemMockDataSource, ItemHTTPDataSource } from './datapi/item/datasource.js';
        import { ItemDataModel } from './datapi/item/datamodel.js';
        import { ItemDataSourceWidget } from './datapi/item/datawidget.js';
        // users
        import { UserMockDataSource, UserHTTPDataSource } from './datapi/user/datasource.js';
        import { UserDataModel } from './datapi/user/datamodel.js';
        import { UserDataSourceWidget } from './datapi/user/datawidget.js';
        
        // datasources
        if (isTestMode) {
            var authUserDataSource = new AuthUserMockDataSource(); // NOTE: not using datamodel
            var itemDataSource = new ItemMockDataSource()
                .setDataModel(new ItemDataModel()).setUUIDKey("id")
                .setPaginationStrategy(new FapiPaginationStrategy())
            var userDataSource = new UserMockDataSource()
                .setDataModel(new UserDataModel()).setUUIDKey("id")
                .setPaginationStrategy(new FapiPaginationStrategy())
        } 
        else {
            var authUserDataSource = new AuthUserHTTPDataSource()
                .setBaseUrl('http://localhost:8000/api/v1')
                .setAuthModel(new LocalStorageAuthModel("access_token"))
            var itemDataSource = new ItemHTTPDataSource()
                .setBaseUrl('http://localhost:8000/api/v1')
                .setDataModel(new ItemDataModel())
                .setUUIDKey("id")
                .setPaginationStrategy(new FapiPaginationStrategy())
                .setAuthModel(new LocalStorageAuthModel("access_token"))
            var userDataSource = new UserHTTPDataSource()
                .setBaseUrl('http://localhost:8000/api/v1')
                .setDataModel(new UserDataModel())
                .setUUIDKey("id")
                .setPaginationStrategy(new FapiPaginationStrategy())
                .setAuthModel(new LocalStorageAuthModel("access_token"))
        }

        // Create all widgets
        const authUserDataSourceWidget = new AuthUserDataSourceWidget('auth-user-datasource-widget', authUserDataSource);
        const itemDataSourceWidget = new ItemDataSourceWidget('item-datasource-widget', itemDataSource);
        const userDataSourceWidget = new UserDataSourceWidget('user-datasource-widget', userDataSource);
        itemDataSourceWidget.setLogLevel(-1); // Enable debug logging
        userDataSourceWidget.setLogLevel(-1); // Enable debug logging

        // Create loading indicator widget (overlay)
        const loadingIndicator = new LoadingIndicatorWidget('loading-indicator');
        loadingIndicator.setLogLevel(-1);

        // Network testing widgets
        if (networkTest) {
            const { NetworkSimulatorWidget } = await import('../lib/base/networksimulatorwidget.js');
            
            // Create network simulator widget (floating panel in bottom-right)
            const networkSimWidget = new NetworkSimulatorWidget('network-sim');
            networkSimWidget.setLogLevel(-1);

            // Wire network simulator to all datasource widgets
            networkSimWidget.signals.simulator_changed.connect(
                (sim) => authUserDataSourceWidget.set_network_simulator_slot(sim)
            );
            networkSimWidget.signals.simulator_changed.connect(
                (sim) => itemDataSourceWidget.set_network_simulator_slot(sim)
            );
            networkSimWidget.signals.simulator_changed.connect(
                (sim) => userDataSourceWidget.set_network_simulator_slot(sim)
            );
        }

        const bannerWidget = new BannerWidget();
        const authUserFloaterWidget = new AuthUserFloaterWidget("userFloater");
        // sections
        const dashboardSection = new DashboardSection();
        const itemsSection = new ItemsSection();
        const settingsSection = new SettingsSection();
        const adminSection = new AdminSection();
        const sections = [dashboardSection, itemsSection, settingsSection, adminSection]
        // Set debug level for all widgets
        sections.forEach(w => w.setLogLevel(-1));

        const container = new ContainerWidget("main-group")
        container.setLogLevel(-1);
        container.setItems({
            dashboardSection: dashboardSection,
            itemsSection: itemsSection,
            settingsSection: settingsSection,
            adminSection: adminSection,
        })
        
        // Define sidebarwidget
        const fapiSidebar = new FapiSidebar("sidebar");
        fapiSidebar.setItems({
            dashboardItem: new SidebarMenuItem('Dashboard', 'dashboard', 'fas fa-home'),
            itemsItem: new SidebarMenuItem('Items', 'items', 'fas fa-box'),
            userSettingsItem: new SidebarMenuItem('User Settings', 'user-settings', 'fas fa-cog'),
            adminItem: new SidebarMenuItem('Admin', 'admin', 'fas fa-user')
        });
        // Clicking sidebar widget's menu elements reveals different sections from container
        fapiSidebar.widgets.dashboardItem.signals.clicked.connect((id)=>container.show_slot(container.widgets.dashboardSection));
        fapiSidebar.widgets.itemsItem.signals.clicked.connect((id)=>container.show_slot(container.widgets.itemsSection));
        fapiSidebar.widgets.userSettingsItem.signals.clicked.connect((id)=>container.show_slot(container.widgets.settingsSection));
        fapiSidebar.widgets.adminItem.signals.clicked.connect((id)=>container.show_slot(container.widgets.adminSection));

        container.show_slot(dashboardSection);

        /* Connect data flow between the data source and the
        items section.  Take a look into section.js:ItemSection how
        the API for this is declared
        */
        // connect datamodel schema to items section
        itemDataSourceWidget.signals.datamodel_create.connect((schema)=> 
            container.widgets.itemsSection.datamodel_slot(schema)
        );
        // connect signal that carries actual data
        itemDataSourceWidget.signals.data.connect((datums)=> 
            container.widgets.itemsSection.widgets.itemList.datums_slot(datums)
        );
        // connect signal that carries pagination info
        itemDataSourceWidget.signals.pagination_changed.connect((paginationInfo)=> 
            container.widgets.itemsSection.widgets.itemList.set_pagination_slot(paginationInfo)
        );
        // connect error signals to warning
        itemDataSourceWidget.signals.error.connect((message) =>
            bannerWidget.error_slot(message)
        );
        // ui release/blocking for datasource network operations
        itemDataSourceWidget.signals.loading_start.connect(
            (op) => loadingIndicator.loading_start_slot(op)
        );
        itemDataSourceWidget.signals.loading_success.connect(
            (op) => loadingIndicator.loading_success_slot(op)
        );
        itemDataSourceWidget.signals.loading_error.connect(
            (data) => loadingIndicator.loading_error_slot(data)
        );

        // connect signal that carries user's pagination request to data source
        container.widgets.itemsSection.signals.page_changed.connect(
            (pageNumber) =>
            itemDataSourceWidget.set_page_slot(pageNumber)
        );
        // connect "create" request to data source
        container.widgets.itemsSection.signals.create.connect(
            (datum) =>
            itemDataSourceWidget.create_slot(datum)
        );
        // connect "update" request to datasource
        container.widgets.itemsSection.signals.update.connect(
            (datum) =>
            itemDataSourceWidget.update_slot(datum)
        );
        // connect "delete" request to datasource
        container.widgets.itemsSection.signals.delete_datum.connect(
            (datum) =>
            itemDataSourceWidget.delete_slot(datum)
        )
        
        // users
        userDataSourceWidget.signals.datamodel_create.connect((schema)=>
            container.widgets.adminSection.datamodel_slot(schema)
        );
        userDataSourceWidget.signals.data.connect((datums)=>
            container.widgets.adminSection.widgets.userList.datums_slot(datums)
        );
        // connect signal that carries pagination info
        userDataSourceWidget.signals.pagination_changed.connect((paginationInfo)=>
            container.widgets.adminSection.widgets.userList.set_pagination_slot(paginationInfo)
        );
        // connect error signals to warning
        userDataSourceWidget.signals.error.connect((message) =>
            bannerWidget.error_slot(message)
        );
        // ui release/blocking for datasource network operations
        userDataSourceWidget.signals.loading_start.connect(
            (op) => loadingIndicator.loading_start_slot(op)
        );
        userDataSourceWidget.signals.loading_success.connect(
            (op) => loadingIndicator.loading_success_slot(op)
        );
        userDataSourceWidget.signals.loading_error.connect(
            (data) => loadingIndicator.loading_error_slot(data)
        );
        // connect signal that carries pagination request to data source
        container.widgets.adminSection.signals.page_changed.connect(
            (pageNumber) =>
            userDataSourceWidget.set_page_slot(pageNumber)
        );
        // connect "create" request to data source
        container.widgets.adminSection.signals.create.connect(
            (datum) =>
            userDataSourceWidget.create_slot(datum)
        );
        // connect "update" request to datasource
        container.widgets.adminSection.signals.update.connect(
            (datum) =>
            userDataSourceWidget.update_slot(datum)
        );
        // connect "delete" request to datasource
        container.widgets.adminSection.signals.delete.connect(
            (datum) =>
            userDataSourceWidget.delete_slot(datum)
        )

        // change user data connections to authUserDataSource
        container.widgets.settingsSection.signals.update_user_data.connect((datum) =>
            authUserDataSourceWidget.updateMe_slot(datum)
        );
        container.widgets.settingsSection.signals.password_changed.connect((data) =>
            authUserDataSourceWidget.updatePassword_slot(data)
        );
        authUserDataSourceWidget.signals.me.connect((datum) =>
            container.widgets.settingsSection.set_datum_slot(datum)
        );
        
        // connections from authUserDataSource to GUI widgets
        authUserDataSourceWidget.signals.me.connect((datum) =>
            fapiSidebar.setAuthUser_slot(datum)
        );
        // data operations un/block UI
        authUserDataSourceWidget.signals.loading_start.connect(
            (op) => loadingIndicator.loading_start_slot(op)
        );
        authUserDataSourceWidget.signals.loading_success.connect(
            (op) => loadingIndicator.loading_success_slot(op)
        );
        authUserDataSourceWidget.signals.loading_error.connect(
            (data) => loadingIndicator.loading_error_slot(data)
        );
        // connections from floating widget for user shortcuts
        authUserFloaterWidget.signals.profile.connect(() =>
            container.show_slot(container.widgets.settingsSection)
        )
        authUserFloaterWidget.signals.logout.connect(() => {
            window.location.href = "landing.html";
        })

        itemDataSourceWidget.model_slot() // propagate datamodel
        itemDataSourceWidget.read_slot() // send data

        userDataSourceWidget.model_slot() // propagate datamodel
        userDataSourceWidget.read_slot() // send data

        authUserDataSourceWidget.me_slot() // propagate info of current user

        window.genDocs = ["container", "itemDataSourceWidget","userDataSourceWidget","authUserFloaterWidget"]

        if (isTestMode) {
            console.log("ðŸ§ª Test mode enabled - injecting test panels");
            container.activate_debug_slot();
        }
    </script>
</body>
</html>
